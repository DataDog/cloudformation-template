AWSTemplateFormatVersion: 2010-09-09
Description: IAM role for Datadog AWS Integration
Parameters:
  ExternalId:
    Description: >-
      External ID for the Datadog role (generate at
      https://app.datadoghq.com/account/settings#integrations/amazon-web-services)
    Type: String
  IAMRoleName:
    Description: Customize the name of IAM role for Datadog AWS integration
    Type: String
    Default: DatadogIntegrationRole
  BasePermissions:
    Description: >-
      Customize the base permissions for the Datadog IAM role.
      Select "Core" to only grant Datadog permissions to a very limited set of metrics and metadata (not recommended).
    Type: String
    Default: Full
    AllowedValues:
      - Full
      - Core
  LogArchives:
    Description: >-
      S3 paths to store log archives for log rehydration. Separate multiple paths with comma,
      e.g., "my-bucket,my-bucket-with-path/path".
    Type: String
    Default: ''
  CloudTrails:
    Description: >-
      S3 buckets for the Datadog CloudTrail integration. Separate multiple buckets with commas,
      e.g., "bucket1,bucket2". Permissions will be automatically added to the Datadog integration IAM role.
      https://docs.datadoghq.com/integrations/amazon_cloudtrail/
    Type: String
    Default: ''
  CloudSecurityPostureManagementPermissions:
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    Description: >-
      Set this value to "true" to add permissions for Datadog's Cloud Security Posture Management product
      to monitor your AWS cloud resource configurations.
      You need this set to "true" to use Cloud Security Posture Management. You will also need "BasePermissions" set to "Full".
  DdAWSAccountId:
    Description: >-
      Datadog AWS account ID allowed to assume the integration IAM role. DO NOT CHANGE!
    Type: String
    Default: '464622532012'
Conditions:
  GrantFullPermissions:
    Fn::Equals:
      - Ref: BasePermissions
      - Full
  ShouldInstallCSPMPolicy:
    Fn::Equals:
      - Ref: CloudSecurityPostureManagementPermissions
      - true
Resources:
  DatadogIntegrationRole:
    Type: 'AWS::IAM::Role'
    Metadata:
      cfn-lint:
        config:
          # cfn-lint does not yet support "Fn::Transform"
          ignore_checks:
            - E3002
            - E3003
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub
                - 'arn:aws:iam::${DdAWSAccountId}:root'
                - { DdAWSAccountId: !Ref DdAWSAccountId }
            Action:
              - 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId
      Path: /
      RoleName: !Ref IAMRoleName
      ManagedPolicyArns:
        !If [
          ShouldInstallCSPMPolicy,
          ['arn:aws:iam::aws:policy/SecurityAudit'],
          !Ref AWS::NoValue,
        ]
      Policies:
        - PolicyName: DatadogAWSIntegrationPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - !If
                - GrantFullPermissions
                - Effect: Allow
                  Resource: '*'
                  Action:
                    - 'account:GetContactInformation'
                    - 'amplify:ListApps'
                    - 'amplify:ListArtifacts'
                    - 'amplify:ListBackendEnvironments'
                    - 'amplify:ListBranches'
                    - 'amplify:ListDomainAssociations'
                    - 'amplify:ListJobs'
                    - 'amplify:ListWebhooks'
                    - 'aoss:BatchGetCollection'
                    - 'aoss:ListCollections'
                    - 'appstream:DescribeAppBlockBuilders'
                    - 'appstream:DescribeAppBlocks'
                    - 'appstream:DescribeApplications'
                    - 'appstream:DescribeFleets'
                    - 'appstream:DescribeImageBuilders'
                    - 'appstream:DescribeImages'
                    - 'appstream:DescribeStacks'
                    - 'aps:DescribeRuleGroupsNamespace'
                    - 'aps:DescribeScraper'
                    - 'aps:DescribeWorkspace'
                    - 'aps:ListRuleGroupsNamespaces'
                    - 'aps:ListScrapers'
                    - 'aps:ListWorkspaces'
                    - 'backup:List*'
                    - 'batch:DescribeJobQueues'
                    - 'batch:DescribeSchedulingPolicies'
                    - 'batch:ListSchedulingPolicies'
                    - 'bcm-data-exports:GetExport'
                    - 'bcm-data-exports:ListExports'
                    - 'bedrock:GetAgent'
                    - 'bedrock:GetAgentActionGroup'
                    - 'bedrock:GetAgentAlias'
                    - 'bedrock:GetAsyncInvoke'
                    - 'bedrock:GetBlueprint'
                    - 'bedrock:GetDataSource'
                    - 'bedrock:GetEvaluationJob'
                    - 'bedrock:GetFlow'
                    - 'bedrock:GetFlowAlias'
                    - 'bedrock:GetFlowVersion'
                    - 'bedrock:GetFoundationModel'
                    - 'bedrock:GetGuardrail'
                    - 'bedrock:GetImportedModel'
                    - 'bedrock:GetInferenceProfile'
                    - 'bedrock:GetIngestionJob'
                    - 'bedrock:GetKnowledgeBase'
                    - 'bedrock:GetMarketplaceModelEndpoint'
                    - 'bedrock:GetModelCopyJob'
                    - 'bedrock:GetModelCustomizationJob'
                    - 'bedrock:GetModelInvocationJob'
                    - 'bedrock:GetPrompt'
                    - 'bedrock:ListAgentActionGroups'
                    - 'bedrock:ListAgentAliases'
                    - 'bedrock:ListAgentCollaborators'
                    - 'bedrock:ListAgentVersions'
                    - 'bedrock:ListAgents'
                    - 'bedrock:ListAsyncInvokes'
                    - 'bedrock:ListBlueprints'
                    - 'bedrock:ListDataSources'
                    - 'bedrock:ListEvaluationJobs'
                    - 'bedrock:ListFlowAliases'
                    - 'bedrock:ListFlows'
                    - 'bedrock:ListFoundationModels'
                    - 'bedrock:ListGuardrails'
                    - 'bedrock:ListImportedModels'
                    - 'bedrock:ListInferenceProfiles'
                    - 'bedrock:ListIngestionJobs'
                    - 'bedrock:ListKnowledgeBaseDocuments'
                    - 'bedrock:ListKnowledgeBases'
                    - 'bedrock:ListMarketplaceModelEndpoints'
                    - 'bedrock:ListModelCopyJobs'
                    - 'bedrock:ListModelCustomizationJobs'
                    - 'bedrock:ListModelInvocationJobs'
                    - 'bedrock:ListPromptRouters'
                    - 'bedrock:ListPrompts'
                    - 'bedrock:ListProvisionedModelThroughputs'
                    - 'budgets:ViewBudget'
                    - 'cassandra:Select'
                    - 'cloudhsm:DescribeBackups'
                    - 'cloudhsm:DescribeClusters'
                    - 'cloudwatch:GetMetricData'
                    - 'cloudwatch:ListMetrics'
                    - 'codeartifact:DescribeDomain'
                    - 'codeartifact:DescribePackageGroup'
                    - 'codeartifact:DescribeRepository'
                    - 'codeartifact:ListDomains'
                    - 'codeartifact:ListPackageGroups'
                    - 'codeartifact:ListPackages'
                    - 'codepipeline:ListWebhooks'
                    - 'connect:DescribeAgentStatus'
                    - 'connect:DescribeAuthenticationProfile'
                    - 'connect:DescribeContactFlow'
                    - 'connect:DescribeContactFlowModule'
                    - 'connect:DescribeHoursOfOperation'
                    - 'connect:DescribeInstance'
                    - 'connect:DescribeQueue'
                    - 'connect:DescribeQuickConnect'
                    - 'connect:DescribeRoutingProfile'
                    - 'connect:DescribeSecurityProfile'
                    - 'connect:DescribeUser'
                    - 'connect:ListAgentStatuses'
                    - 'connect:ListAuthenticationProfiles'
                    - 'connect:ListContactFlowModules'
                    - 'connect:ListContactFlows'
                    - 'connect:ListHoursOfOperations'
                    - 'connect:ListQueues'
                    - 'connect:ListQuickConnects'
                    - 'connect:ListRoutingProfiles'
                    - 'connect:ListSecurityProfiles'
                    - 'connect:ListUsers'
                    - 'controltower:GetLandingZone'
                    - 'controltower:ListEnabledBaselines'
                    - 'controltower:ListEnabledControls'
                    - 'controltower:ListLandingZones'
                    - 'cur:DescribeReportDefinitions'
                    - 'datazone:GetDomain'
                    - 'datazone:ListDomains'
                    - 'deadline:GetBudget'
                    - 'deadline:GetLicenseEndpoint'
                    - 'deadline:GetQueue'
                    - 'deadline:ListBudgets'
                    - 'deadline:ListFarms'
                    - 'deadline:ListFleets'
                    - 'deadline:ListLicenseEndpoints'
                    - 'deadline:ListMonitors'
                    - 'deadline:ListQueues'
                    - 'deadline:ListWorkers'
                    - 'dlm:GetLifecyclePolicies'
                    - 'dlm:GetLifecyclePolicy'
                    - 'docdb-elastic:GetCluster'
                    - 'docdb-elastic:GetClusterSnapshot'
                    - 'docdb-elastic:ListClusterSnapshots'
                    - 'drs:DescribeJobs'
                    - 'drs:DescribeLaunchConfigurationTemplates'
                    - 'drs:DescribeRecoveryInstances'
                    - 'drs:DescribeReplicationConfigurationTemplates'
                    - 'drs:DescribeSourceNetworks'
                    - 'drs:DescribeSourceServers'
                    - 'dsql:GetCluster'
                    - 'dsql:ListClusters'
                    - 'dynamodb:Describe*'
                    - 'dynamodb:List*'
                    - 'ec2:GetAllowedImagesSettings'
                    - 'ec2:GetEbsDefaultKmsKeyId'
                    - 'ec2:GetInstanceMetadataDefaults'
                    - 'ec2:GetSerialConsoleAccessStatus'
                    - 'ec2:GetSnapshotBlockPublicAccessState'
                    - 'ec2:GetVerifiedAccessEndpointPolicy'
                    - 'ec2:GetVerifiedAccessEndpointTargets'
                    - 'ec2:GetVerifiedAccessGroupPolicy'
                    - 'elasticache:List*'
                    - 'elasticmapreduce:List*'
                    - 'emr-containers:ListManagedEndpoints'
                    - 'emr-containers:ListSecurityConfigurations'
                    - 'emr-containers:ListVirtualClusters'
                    - 'events:CreateEventBus'
                    - 'glacier:GetVaultNotifications'
                    - 'glue:ListRegistries'
                    - 'grafana:DescribeWorkspace'
                    - 'greengrass:GetComponent'
                    - 'greengrass:GetConnectivityInfo'
                    - 'greengrass:GetCoreDevice'
                    - 'greengrass:GetDeployment'
                    - 'imagebuilder:GetContainerRecipe'
                    - 'imagebuilder:GetDistributionConfiguration'
                    - 'imagebuilder:GetImageRecipe'
                    - 'imagebuilder:GetInfrastructureConfiguration'
                    - 'imagebuilder:GetLifecyclePolicy'
                    - 'imagebuilder:GetWorkflow'
                    - 'imagebuilder:ListComponents'
                    - 'imagebuilder:ListContainerRecipes'
                    - 'imagebuilder:ListDistributionConfigurations'
                    - 'imagebuilder:ListImagePipelines'
                    - 'imagebuilder:ListImageRecipes'
                    - 'imagebuilder:ListImages'
                    - 'imagebuilder:ListInfrastructureConfigurations'
                    - 'imagebuilder:ListLifecyclePolicies'
                    - 'imagebuilder:ListWorkflows'
                    - 'iotsitewise:DescribeAsset'
                    - 'iotsitewise:DescribeAssetModel'
                    - 'iotsitewise:DescribeDashboard'
                    - 'iotsitewise:DescribeDataset'
                    - 'iotsitewise:DescribePortal'
                    - 'iotsitewise:DescribeProject'
                    - 'iotsitewise:ListAssets'
                    - 'iotsitewise:ListDashboards'
                    - 'iotsitewise:ListDatasets'
                    - 'iotsitewise:ListPortals'
                    - 'iotsitewise:ListProjects'
                    - 'iotsitewise:ListTimeSeries'
                    - 'iottwinmaker:GetComponentType'
                    - 'iottwinmaker:GetEntity'
                    - 'iottwinmaker:GetScene'
                    - 'iottwinmaker:GetWorkspace'
                    - 'iottwinmaker:ListComponentTypes'
                    - 'iottwinmaker:ListEntities'
                    - 'iottwinmaker:ListScenes'
                    - 'iotwireless:GetDeviceProfile'
                    - 'iotwireless:GetMulticastGroup'
                    - 'iotwireless:GetNetworkAnalyzerConfiguration'
                    - 'iotwireless:GetServiceProfile'
                    - 'iotwireless:GetWirelessDevice'
                    - 'iotwireless:GetWirelessGateway'
                    - 'iotwireless:ListDestinations'
                    - 'iotwireless:ListDeviceProfiles'
                    - 'iotwireless:ListMulticastGroups'
                    - 'iotwireless:ListNetworkAnalyzerConfigurations'
                    - 'iotwireless:ListServiceProfiles'
                    - 'iotwireless:ListWirelessDevices'
                    - 'iotwireless:ListWirelessGateways'
                    - 'ivs:GetChannel'
                    - 'ivs:GetRecordingConfiguration'
                    - 'ivs:ListChannels'
                    - 'ivs:ListPlaybackKeyPairs'
                    - 'ivs:ListPlaybackRestrictionPolicies'
                    - 'ivs:ListRecordingConfigurations'
                    - 'ivs:ListStreamKeys'
                    - 'ivschat:GetLoggingConfiguration'
                    - 'ivschat:GetRoom'
                    - 'ivschat:ListLoggingConfigurations'
                    - 'ivschat:ListRooms'
                    - 'kinesis:Describe*'
                    - 'kinesis:List*'
                    - 'lambda:GetFunction'
                    - 'lambda:GetPolicy'
                    - 'lambda:List*'
                    - 'launchwizard:GetDeployment'
                    - 'launchwizard:ListDeployments'
                    - 'lightsail:GetInstancePortStates'
                    - 'logs:DeleteSubscriptionFilter'
                    - 'logs:DescribeLogGroups'
                    - 'logs:DescribeLogStreams'
                    - 'logs:DescribeSubscriptionFilters'
                    - 'logs:FilterLogEvents'
                    - 'logs:PutSubscriptionFilter'
                    - 'logs:TestMetricFilter'
                    - 'macie2:GetAllowList'
                    - 'macie2:GetCustomDataIdentifier'
                    - 'macie2:GetMacieSession'
                    - 'macie2:ListAllowLists'
                    - 'macie2:ListCustomDataIdentifiers'
                    - 'macie2:ListMembers'
                    - 'managedblockchain:GetAccessor'
                    - 'managedblockchain:GetMember'
                    - 'managedblockchain:GetNetwork'
                    - 'managedblockchain:GetNode'
                    - 'managedblockchain:GetProposal'
                    - 'managedblockchain:ListAccessors'
                    - 'managedblockchain:ListInvitations'
                    - 'managedblockchain:ListMembers'
                    - 'managedblockchain:ListNodes'
                    - 'managedblockchain:ListProposals'
                    - 'memorydb:DescribeAcls'
                    - 'memorydb:DescribeMultiRegionClusters'
                    - 'memorydb:DescribeParameterGroups'
                    - 'memorydb:DescribeReservedNodes'
                    - 'memorydb:DescribeSnapshots'
                    - 'memorydb:DescribeSubnetGroups'
                    - 'memorydb:DescribeUsers'
                    - 'mobiletargeting:GetApps'
                    - 'mobiletargeting:GetCampaigns'
                    - 'mobiletargeting:GetChannels'
                    - 'mobiletargeting:GetEventStream'
                    - 'mobiletargeting:GetRecommenderConfigurations'
                    - 'mobiletargeting:GetSegments'
                    - 'mobiletargeting:ListJourneys'
                    - 'mobiletargeting:ListTemplates'
                    - 'networkmanager:GetConnectPeer'
                    - 'networkmanager:GetConnections'
                    - 'networkmanager:GetCoreNetwork'
                    - 'networkmanager:GetDevices'
                    - 'networkmanager:GetLinks'
                    - 'networkmanager:GetSites'
                    - 'networkmanager:ListAttachments'
                    - 'networkmanager:ListConnectPeers'
                    - 'networkmanager:ListCoreNetworks'
                    - 'networkmanager:ListPeerings'
                    - 'oam:ListAttachedLinks'
                    - 'oam:ListSinks'
                    - 'osis:GetPipeline'
                    - 'osis:GetPipelineBlueprint'
                    - 'osis:ListPipelineBlueprints'
                    - 'osis:ListPipelines'
                    - 'pca-connector-ad:ListConnectors'
                    - 'pca-connector-ad:ListTemplates'
                    - 'pca-connector-scep:ListConnectors'
                    - 'pipes:ListPipes'
                    - 'proton:GetComponent'
                    - 'proton:GetDeployment'
                    - 'proton:GetEnvironment'
                    - 'proton:GetEnvironmentAccountConnection'
                    - 'proton:GetEnvironmentTemplate'
                    - 'proton:GetEnvironmentTemplateVersion'
                    - 'proton:GetRepository'
                    - 'proton:GetService'
                    - 'proton:GetServiceInstance'
                    - 'proton:GetServiceTemplate'
                    - 'proton:GetServiceTemplateVersion'
                    - 'proton:ListComponents'
                    - 'proton:ListDeployments'
                    - 'proton:ListEnvironmentAccountConnections'
                    - 'proton:ListEnvironmentTemplateVersions'
                    - 'proton:ListEnvironmentTemplates'
                    - 'proton:ListEnvironments'
                    - 'proton:ListRepositories'
                    - 'proton:ListServiceInstances'
                    - 'proton:ListServiceTemplateVersions'
                    - 'proton:ListServiceTemplates'
                    - 'proton:ListServices'
                    - 'qbusiness:GetApplication'
                    - 'qbusiness:GetDataAccessor'
                    - 'qbusiness:GetDataSource'
                    - 'qbusiness:GetIndex'
                    - 'qbusiness:GetPlugin'
                    - 'qbusiness:GetRetriever'
                    - 'qbusiness:GetWebExperience'
                    - 'qbusiness:ListDataAccessors'
                    - 'qldb:ListJournalKinesisStreamsForLedger'
                    - 'ram:GetResourceShareInvitations'
                    - 'rbin:GetRule'
                    - 'rbin:ListRules'
                    - 'rds:List*'
                    - 'redshift-serverless:ListEndpointAccess'
                    - 'redshift-serverless:ListManagedWorkgroups'
                    - 'redshift-serverless:ListNamespaces'
                    - 'redshift-serverless:ListRecoveryPoints'
                    - 'redshift-serverless:ListSnapshots'
                    - 'resiliencehub:DescribeApp'
                    - 'resiliencehub:DescribeAppAssessment'
                    - 'resiliencehub:ListAppAssessments'
                    - 'resiliencehub:ListApps'
                    - 'resiliencehub:ListRecommendationTemplates'
                    - 'resiliencehub:ListResiliencyPolicies'
                    - 'resource-explorer-2:GetIndex'
                    - 'resource-explorer-2:GetManagedView'
                    - 'resource-explorer-2:GetView'
                    - 'resource-explorer-2:ListManagedViews'
                    - 'resource-explorer-2:ListViews'
                    - 'resource-groups:GetGroup'
                    - 'resource-groups:ListGroups'
                    - 'resourcegroupstaggingapi:GetResources'
                    - 'rum:GetAppMonitor'
                    - 'rum:ListAppMonitors'
                    - 's3-outposts:ListRegionalBuckets'
                    - 's3:GetBucketLocation'
                    - 's3:GetBucketLogging'
                    - 's3:GetBucketNotification'
                    - 's3:GetBucketTagging'
                    - 's3:PutBucketNotification'
                    - 'savingsplans:DescribeSavingsPlanRates'
                    - 'savingsplans:DescribeSavingsPlans'
                    - 'scheduler:GetSchedule'
                    - 'scheduler:ListScheduleGroups'
                    - 'scheduler:ListSchedules'
                    - 'ses:Get*'
                    - 'ses:List*'
                    - 'signer:GetSigningProfile'
                    - 'signer:ListSigningProfiles'
                    - 'sms-voice:DescribeConfigurationSets'
                    - 'sms-voice:DescribeOptOutLists'
                    - 'sms-voice:DescribePhoneNumbers'
                    - 'sms-voice:DescribePools'
                    - 'sms-voice:DescribeProtectConfigurations'
                    - 'sms-voice:DescribeRegistrationAttachments'
                    - 'sms-voice:DescribeRegistrations'
                    - 'sms-voice:DescribeSenderIds'
                    - 'sms-voice:DescribeVerifiedDestinationNumbers'
                    - 'sns:GetSubscriptionAttributes'
                    - 'sns:List*'
                    - 'sns:Publish'
                    - 'social-messaging:GetLinkedWhatsAppBusinessAccount'
                    - 'social-messaging:ListLinkedWhatsAppBusinessAccounts'
                    - 'support:DescribeTrustedAdvisor*'
                    - 'support:RefreshTrustedAdvisorCheck'
                    - 'tag:GetTagValues'
                    - 'timestream:DescribeEndpoints'
                    - 'timestream:ListTables'
                    - 'waf-regional:GetRule'
                    - 'waf-regional:GetRuleGroup'
                    - 'waf-regional:ListRuleGroups'
                    - 'waf-regional:ListRules'
                    - 'waf:GetRule'
                    - 'waf:GetRuleGroup'
                    - 'waf:ListRuleGroups'
                    - 'waf:ListRules'
                    - 'wafv2:GetIPSet'
                    - 'wafv2:GetRegexPatternSet'
                    - 'wafv2:GetRuleGroup'
                    - 'workmail:DescribeOrganization'
                    - 'workmail:ListOrganizations'
                    - 'xray:BatchGetTraces'
                - Effect: Allow
                  Resource: '*'
                  Action:
                    - 'cloudwatch:Get*'
                    - 'cloudwatch:List*'
                    - 'ec2:Describe*'
                    - 'tag:GetResources'
                    - 'tag:GetTagKeys'
                    - 'tag:GetTagValues'
        - Fn::Transform:
            - Name: 'DatadogPolicy'
              Parameters:
                PolicyType: LogArchive
                LogArchives: !Ref LogArchives
        - Fn::Transform:
            - Name: 'DatadogPolicy'
              Parameters:
                PolicyType: CloudTrail
                CloudTrails: !Ref CloudTrails
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Required
        Parameters:
          - ExternalId
          - IAMRoleName
          - BasePermissions
      - Label:
          default: Optional
        Parameters:
          - LogArchives
          - CloudTrails
          - CloudSecurityPostureManagementPermissions
